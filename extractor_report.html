<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AGENT_X • EXTRACTOR REPORT • v1.0</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#141b22; --text:#e9f0f7; --muted:#9fb0c3;
    --ok:#00d47e; --start:#3aa0ff; --block:#ff4d5a; --accent:#ff9a66;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 80% -10%, #14202b 0%, var(--bg) 55%);
       color:var(--text);font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(90deg,#f8a85a,#ffc06a);color:#161d26;font-weight:900}
  .shell{display:grid;grid-template-columns:480px 1fr;gap:16px;height:calc(100% - 64px);padding:12px}
  .panel{background:var(--panel);border:1px solid #263646;border-radius:18px;box-shadow:0 18px 45px rgba(0,0,0,.45);padding:12px;overflow:hidden}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;height:100%}
  .card{background:#101820;border:1px solid #2b3a49;border-radius:18px;padding:16px;position:relative}
  .title{font-weight:900;margin-bottom:6px}
  .kpi{font-size:38px;font-weight:900}
  .small{font-size:12px;color:var(--muted)}
  .bar{height:14px;background:#0b1218;border:1px solid #243243;border-radius:9px;overflow:hidden;margin-top:8px}
  .bar>span{display:block;height:100%}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#1a2330;color:var(--text);border:1px solid #2c3a48;padding:9px 14px;border-radius:12px;cursor:pointer}
  .btn:hover{transform:translateY(-1px)}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .ok{background:var(--ok)} .start{background:var(--start)} .block{background:var(--block)}
  ul{margin:8px 0 0 18px;padding:0;line-height:1.35}
  #log{white-space:pre-wrap;height:calc(100% - 40px);overflow:auto;font-family:ui-monospace,Consolas,monaco,monospace}
</style>
</head>
<body>
<header>
  <div>AGENT_X • EXTRACTOR REPORT <span style="opacity:.75">v1.0 • Non-Scroll</span></div>
  <div class="row">
    <button class="btn" id="btnFull">Full-Cycle</button>
    <button class="btn" id="btnScan">Scan</button>
    <button class="btn" id="btnKpi">KPI Update</button>
  </div>
</header>

<section class="shell">
  <aside class="panel">
    <div style="font-weight:900;margin-bottom:6px">Status & Log</div>
    <div id="ts" class="small">–</div>
    <div id="log">–</div>
  </aside>
  <main class="panel">
    <div class="grid" id="grid"></div>
  </main>
</section>

<script>
const WEBHOOK_URL = 'REPLACE_WITH_YOUR_EXEC_URL';
const $ = sel => document.querySelector(sel);
const grid = $("#grid");
const log = (obj,label='')=>{
  const ts = new Date().toLocaleString('de-DE');
  const txt = (typeof obj==='string')?obj:JSON.stringify(obj,null,2);
  $("#log").textContent = ts+"\n"+(label?label+": ":"")+txt+"\n\n"+$("#log").textContent.slice(0,15000);
  $("#ts").textContent = ts;
};
const pct = n => Math.max(0,Math.min(100,Math.round(Number(n||0))));
async function jget(url){ const r=await fetch(url,{cache:'no-store'}); const ct=(r.headers.get('content-type')||''); return ct.includes('json')? r.json(): r.text(); }

function card(title, value, sub, p, status='start'){
  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `
    <div class="title">${title}</div>
    <div class="kpi">${value}</div>
    <div class="small">${sub}</div>
    <div class="bar"><span style="width:${pct(p)}%;background:var(--${status})"></span></div>
  `;
  return div;
}

function renderKpis(stats){
  grid.innerHTML = '';
  const s = stats||{};
  grid.appendChild(card('ZIP-Dateien', s.zip_count||0, 'davon >500MB: '+(s.zip_large||0), (s.zip_processed||0)/(s.zip_count||1)*100, (s.zip_backlog||0)>0?'start':'ok'));
  grid.appendChild(card('Extrahierte Dateien', s.extracted_count||0, 'Text/CSV/JSON', (s.extracted_count||0)%100, 'ok'));
  grid.appendChild(card('Ideen erkannt', s.ideas||0, 'semantische Treffer', (s.ideas||0)%100, 'start'));
  grid.appendChild(card('Projekte erkannt', s.projects||0, 'semantische Treffer', (s.projects||0)%100, 'start'));
  grid.appendChild(card('Fehler', s.errors||0, 'letzte 24h', 100, (s.errors||0)>0?'block':'ok'));
  grid.appendChild(card('Sheet Sync', s.sheet_rows||0, 'Zeilen gesamt', Math.min(100, (s.sheet_rows||0)/1000*100), 'ok'));
  grid.appendChild(card('Durchsatz', (s.throughput_per_min||0)+'/min', 'Ø Dateien/min', Math.min(100,(s.throughput_per_min||0)/60*100), 'ok'));
  grid.appendChild(card('Queue', s.queue||0, 'offene Jobs', Math.min(100,(s.queue||0)%100), (s.queue||0)>0?'start':'ok'));
  grid.appendChild(card('Letzte Laufzeit', (s.last_runtime_sec||0)+'s', 'Full-Cycle', Math.min(100,(s.last_runtime_sec||0)/600*100), 'ok'));
}

async function sync(){
  try{
    const d = await jget(WEBHOOK_URL+'?cmd=stats');
    renderKpis(d?.stats||{});
    log(d,'Stats');
  }catch(e){ log(String(e),'Stats ERR'); }
}

async function run(cmd,label){
  try{
    const r = await jget(WEBHOOK_URL+'?cmd='+cmd);
    log(r,label);
    await sync();
  }catch(e){ log(String(e), label+' ERR'); }
}

document.getElementById('btnFull').onclick=()=>run('full_cycle','Full-Cycle');
document.getElementById('btnScan').onclick =()=>run('scan','Scan');
document.getElementById('btnKpi').onclick  =()=>run('kpi_update','KPI');

(async()=>{ await sync(); })();
</script>
</body>
</html>