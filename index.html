<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentX LIVE BETA V1.0 · Hauptdashboard v1.7 (Live)</title>
<style>
  :root{--bg:#0b0e16;--ink:#eaf4ff;--edge:#1a2231;--cyan:#2fb7ff;--orange:#ff9f1a;--lime:#8bdc65;--panel:#0e1420;--card:#111722}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:12px 16px;background:linear-gradient(90deg,rgba(47,183,255,.35),transparent 50%);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--edge)}
  .ver{background:#172034;color:#b7c6d9;border-radius:999px;padding:2px 10px;font-size:.82rem}
  #grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:18px;padding:14px;min-height:130px;display:flex;flex-direction:column;gap:8px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.02)}
  .card h3{margin:0 0 6px 0;font-size:1.08rem;letter-spacing:.2px}
  .kpi{opacity:.92}
  .bar{height:12px;background:#0b1322;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:var(--cyan)}
  .btn{margin-top:auto;align-self:flex-start;background:#1a2231;border:0;color:var(--ink);padding:8px 12px;border-radius:999px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  /* Modal */
  #lcarsModal{position:fixed;inset:0;display:none;z-index:9999}
  #lcarsModal.show{display:block}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
  .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1100px,92vw);height:min(80vh,720px);background:var(--panel);border:1px solid var(--edge);border-radius:18px;box-shadow:0 20px 48px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden}
  .accent{height:8px;background:var(--cyan)}
  .head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
  .close{all:unset;background:#1a2231;padding:8px 12px;border-radius:999px;cursor:pointer}
  .body{padding:0;height:100%}
  .drill{width:100%;height:100%;border:0;background:#0b0e16}
  @media (max-width:1200px){#grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:820px){#grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div>AgentX Live BETA V1.0 <span class="ver">v1.7</span></div>
  <div id="status">Snapshot: — · Dateien: —</div>
</header>

<div id="grid">
  <!-- Karte 1: Drive -->
  <div class="card" id="cardDrive">
    <h3>Drive</h3>
    <div class="kpi" id="driveFiles">Dateien: —</div>
    <div class="bar"><span id="driveProgress" style="width:0%"></span></div>
    <button class="btn" onclick="openDrill('Drive Status (Live)','orange', '')">Details</button>
  </div>

  <!-- Karte 2: Offene Punkte -->
  <div class="card" id="cardOpen">
    <h3>Offene Punkte</h3>
    <div class="kpi" id="openSummary">P1: — · P2: — · P3: —</div>
    <div class="bar"><span id="openProgress" style="width:0%"></span></div>
    <button class="btn" onclick="openDrill('Offene Punkte · P1','orange','only=offen&prio=1')">Details</button>
  </div>

  <!-- Karte 3: Regel-Updates -->
  <div class="card" id="cardRules">
    <h3>Regel-Updates</h3>
    <div class="kpi" id="rulesSummary">Einträge: —</div>
    <button class="btn" onclick="openDrill('Regel-Updates','cyan','only=regeln')">Details</button>
  </div>

  <!-- Karte 4: Versionierung -->
  <div class="card" id="cardVersion">
    <h3>Versionierung</h3>
    <div class="kpi" id="versionText">—</div>
    <button class="btn" onclick="openDrill('Versionierung','cyan','only=version')">Details</button>
  </div>
</div>

<!-- Modal -->
<div id="lcarsModal" aria-hidden="true">
  <div class="backdrop" onclick="closeDrill()"></div>
  <div class="panel">
    <div class="accent" id="accent"></div>
    <div class="head">
      <div id="modalTitle">Details</div>
      <button class="close" onclick="closeDrill()">✖</button>
    </div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<script>
  // === 1) KONFIG ===
  const DATA_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwyn7YNLnHkiak3b-3Euqae1_gZZEfiN2Y7S3Qk_T8_CWk_PUnYLQxh155Bx7r6Eh6FWg/exec';
  // **404-Fix: relative URL (gleicher Ordner wie index.html)**
  const LCARS_IFRAME_URL_BASE = './chatoptimizier_log_v1_6_lcars_refined.html';

  // === 2) LIVE-DATEN LADEN ===
  async function loadData(){
    try{
      const res = await fetch(DATA_ENDPOINT, { cache:'no-store', mode:'cors' });
      const data = await res.json();
      render(data);
    }catch(e){
      document.getElementById('status').textContent = 'Snapshot: — · Fehler beim Laden';
      console.error(e);
    }
  }
  function render(data){
    const files = data.stats?.fileCount ?? (data.files?.length ?? 0);
    const snap = (data.snapshot? new Date(data.snapshot): new Date())
      .toLocaleString('de-DE',{timeZone:'Europe/Madrid'});
    document.getElementById('status').textContent = `Snapshot: ${snap} · Dateien: ${files}`;

    // Drive
    document.getElementById('driveFiles').textContent = `Dateien: ${files}`;
    document.getElementById('driveProgress').style.width =
      (data.modules?.find(m=>/Erfolgsquote/i.test(m.title))?.progress ?? 0) + '%';

    // Offene Punkte
    const open = data.modules?.find(m=>/Offene Punkte/i.test(m.title));
    if(open){
      const subs = open.subs||[];
      const p1 = subs.filter(s=>+s.prio===1).length;
      const p2 = subs.filter(s=>+s.prio===2).length;
      const p3 = subs.filter(s=>+s.prio===3).length;
      document.getElementById('openSummary').textContent = `P1: ${p1} · P2: ${p2} · P3: ${p3}`;
      document.getElementById('openProgress').style.width = (open.progress ?? 0) + '%';
    }

    // Regeln
    const rules = data.modules?.find(m=>/Regel-Updates/i.test(m.title));
    if(rules){
      const rcount = (rules.subs||[]).filter(s=>/R00\d/i.test(s.label||'')).length || (rules.subs||[]).length || 0;
      document.getElementById('rulesSummary').textContent = `Einträge: ${rcount}`;
    }

    // Versionierung
    const ver = data.modules?.find(m=>/Versionierung/i.test(m.title));
    document.getElementById('versionText').textContent = (ver?.subs?.[0]?.label) || '—';
  }

  // === 3) AUTO-REFRESH ===
  loadData();
  setInterval(loadData, 120000);

  // === 4) MODAL (iFrame Drilldown) — mit Parametern ===
  function openDrill(title, color, queryParams){
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('accent').style.background =
      (color==='orange'? 'var(--orange)': color==='lime'? 'var(--lime)': 'var(--cyan)');

    const url = LCARS_IFRAME_URL_BASE + (queryParams ? ('?' + queryParams) : '');
    document.getElementById('modalBody').innerHTML =
      `<iframe class="drill" id="lcarsFrame" src="${url}" loading="lazy"></iframe>`;

    const modal=document.getElementById('lcarsModal');
    modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    document.addEventListener('keydown', escClose);
  }
  function closeDrill(){
    const modal=document.getElementById('lcarsModal');
    modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', escClose);
  }
  function escClose(e){ if(e.key==='Escape') closeDrill(); }
</script>
</body>
</html>
