<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent_X · Ebene 1 (Module) · v1.1</title>
<style>
  :root{--bg:#0b0e16;--ink:#eaf4ff;--edge:#1a2231;--cyan:#2fb7ff;--orange:#ff9f1a;--lime:#8bdc65;--panel:#0e1420;--card:#111722}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:12px 16px;background:linear-gradient(90deg,rgba(47,183,255,.35),transparent 50%);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--edge)}
  .ver{background:#172034;color:#b7c6d9;border-radius:999px;padding:2px 10px;font-size:.82rem}
  #grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:18px;padding:14px;min-height:130px;display:flex;flex-direction:column;gap:8px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.02)}
  .card h3{margin:0 0 6px 0;font-size:1.08rem;letter-spacing:.2px}
  .kpi{opacity:.92}
  .bar{height:12px;background:#0b1322;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:var(--cyan)}
  .btn{margin-top:auto;align-self:flex-start;background:#1a2231;border:0;color:var(--ink);padding:8px 12px;border-radius:999px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  /* Modal */
  #lcarsModal{position:fixed;inset:0;display:none;z-index:9999}
  #lcarsModal.show{display:block}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
  .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(1100px,92vw);height:min(80vh,720px);background:var(--panel);border:1px solid var(--edge);border-radius:18px;box-shadow:0 20px 48px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden}
  .accent{height:8px;background:var(--cyan)}
  .head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
  .close{all:unset;background:#1a2231;padding:8px 12px;border-radius:999px;cursor:pointer}
  .body{padding:0;height:100%}
  .drill{width:100%;height:100%;border:0;background:#0b0e16}
  @media (max-width:1200px){#grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:820px){#grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div>Agent_X Ebene 1 <span class="ver">v1.1</span></div>
  <div id="status">Snapshot: — · Dateien: —</div>
</header>

<div class="tip" style="padding:0 16px 6px 16px;color:#9ab1c9">
  Modul: <span id="modName">—</span> · <a href="./" style="color:#9fd0ff">zur Ebene 0</a>
</div>

<div id="grid">
  <div class="card">
    <h3>Drive</h3>
    <div class="kpi" id="driveFiles">Dateien: —</div>
    <div class="bar"><span id="driveProgress" style="width:0%"></span></div>
    <button class="btn" onclick="openDrill('Drive Status (Live)','orange', '')">Details</button>
  </div>
  <div class="card">
    <h3>Offene Punkte</h3>
    <div class="kpi" id="openSummary">P1: — · P2: — · P3: —</div>
    <div class="bar"><span id="openProgress" style="width:0%"></span></div>
    <button class="btn" onclick="openDrill('Offene Punkte · P1','orange','only=offen&prio=1')">Details</button>
  </div>
  <div class="card">
    <h3>Regel-Updates</h3>
    <div class="kpi" id="rulesSummary">Einträge: —</div>
    <button class="btn" onclick="openDrill('Regel-Updates','cyan','only=regeln')">Details</button>
  </div>
  <div class="card">
    <h3>Versionierung</h3>
    <div class="kpi" id="versionText">—</div>
    <button class="btn" onclick="openDrill('Versionierung','cyan','only=version')">Details</button>
  </div>
</div>

<!-- Modal -->
<div id="lcarsModal" aria-hidden="true">
  <div class="backdrop" onclick="closeDrill()"></div>
  <div class="panel">
    <div class="accent" id="accent"></div>
    <div class="head">
      <div id="modalTitle">Details</div>
      <button class="close" onclick="closeDrill()">✖</button>
    </div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<script>
  // URL aus Ebene 0:
  const params = new URLSearchParams(location.search);
  const MOD = decodeURIComponent(params.get('mod')||'—');
  document.getElementById('modName').textContent = MOD;

  // DATA + Drill wie gehabt:
  const DATA_ENDPOINT = 'REPLACE_WITH_YOUR_WEB_APP_URL';
  const LCARS_IFRAME_URL_BASE = './chatoptimizier_log_v1_6_lcars_refined.html';

  async function loadData(){
    try{
      const res = await fetch(DATA_ENDPOINT, { cache:'no-store', mode:'cors' });
      const data = await res.json();
      render(data);
    }catch(e){
      document.getElementById('status').textContent = 'Snapshot: — · Fehler beim Laden';
      console.error(e);
    }
  }
  function render(data){
    const files = data.stats?.fileCount ?? (data.files?.length ?? 0);
    const snap = (data.snapshot? new Date(data.snapshot): new Date()).toLocaleString('de-DE',{timeZone:'Europe/Madrid'});
    document.getElementById('status').textContent = `Snapshot: ${snap} · Dateien: ${files}`;
    document.getElementById('driveFiles').textContent = `Dateien: ${files}`;
    document.getElementById('driveProgress').style.width =
      (data.modules?.find(m=>/Erfolgsquote/i.test(m.title))?.progress ?? 0) + '%';

    const open = data.modules?.find(m=>/Offene Punkte/i.test(m.title));
    if(open){
      const subs = open.subs||[];
      const p1 = subs.filter(s=>+s.prio===1).length;
      const p2 = subs.filter(s=>+s.prio===2).length;
      const p3 = subs.filter(s=>+s.prio===3).length;
      document.getElementById('openSummary').textContent = `P1: ${p1} · P2: ${p2} · P3: ${p3}`;
      document.getElementById('openProgress').style.width = (open.progress ?? 0) + '%';
    }

    const rules = data.modules?.find(m=>/Regel-Updates/i.test(m.title));
    if(rules){
      const rcount = (rules.subs||[]).length || 0;
      document.getElementById('rulesSummary').textContent = `Einträge: ${rcount}`;
    }
    const ver = data.modules?.find(m=>/Versionierung/i.test(m.title));
    document.getElementById('versionText').textContent = (ver?.subs?.[0]?.label) || '—';
  }

  loadData();
  setInterval(loadData, 120000);

  function openDrill(title, color, queryParams){
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('accent').style.background =
      (color==='orange'? '#ff9f1a' : color==='lime'? '#8bdc65' : '#2fb7ff');
    const url = LCARS_IFRAME_URL_BASE + (queryParams ? ('?' + queryParams) : '');
    document.getElementById('modalBody').innerHTML =
      `<iframe class="drill" id="lcarsFrame" src="${url}" loading="lazy"></iframe>`;
    document.getElementById('lcarsModal').classList.add('show');
  }
  function closeDrill(){ document.getElementById('lcarsModal').classList.remove('show'); }
</script>
</body>
</html>
